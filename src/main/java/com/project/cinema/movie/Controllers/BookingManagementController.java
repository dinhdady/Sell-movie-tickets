package com.project.cinema.movie.Controllers;

import com.project.cinema.movie.Models.Booking;
import com.project.cinema.movie.Models.Ticket;
import com.project.cinema.movie.Models.ResponseObject;
import com.project.cinema.movie.DTO.BookingDetailsResponse;
import com.project.cinema.movie.Services.BookingService;
import com.project.cinema.movie.Services.TicketService;
import com.project.cinema.movie.Repositories.BookingRepository;
import com.project.cinema.movie.Repositories.TicketRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;
import java.util.HashMap;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/admin/bookings")
@CrossOrigin(origins = {"http://localhost:5173", "http://127.0.0.1:5173"}, allowCredentials = "true")
public class BookingManagementController {

    @Autowired
    private BookingService bookingService;
    
    @Autowired
    private TicketService ticketService;
    
    @Autowired
    private BookingRepository bookingRepository;
    
    @Autowired
    private TicketRepository ticketRepository;

    // Test endpoint khÃ´ng cáº§n auth - Láº¥y táº¥t cáº£ vÃ© tá»« TicketService
    @GetMapping("/test")
    public ResponseEntity<ResponseObject> testEndpoint() {
        try {
            // Sá»­ dá»¥ng TicketService Ä‘á»ƒ láº¥y táº¥t cáº£ vÃ© cá»§a táº¥t cáº£ user
            List<BookingDetailsResponse> tickets = ticketService.getAllTicketsWithDetails();
            System.out.println("ðŸŽ¯ [ADMIN] Found " + tickets.size() + " tickets from TicketService");
            
            // Log má»™t vÃ i ticket Ä‘á»ƒ debug
            if (!tickets.isEmpty()) {
                System.out.println("ðŸŽ¯ [ADMIN] Sample ticket: " + tickets.get(0));
            }
            
            return ResponseEntity.ok(new ResponseObject("200", "Test endpoint works! All tickets retrieved successfully! Found " + tickets.size() + " tickets", tickets));
        } catch (Exception e) {
            System.err.println("ðŸŽ¯ [ADMIN] Error in test endpoint: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ResponseObject("500", "Test endpoint error: " + e.getMessage(), null));
        }
    }
    
    // Test endpoint Ä‘Æ¡n giáº£n Ä‘á»ƒ kiá»ƒm tra dá»¯ liá»‡u
    @GetMapping("/debug")
    public ResponseEntity<ResponseObject> debugEndpoint() {
        try {
            // Láº¥y táº¥t cáº£ tickets tá»« database
            List<Ticket> allTickets = ticketRepository.findAll();
            System.out.println("ðŸŽ¯ [ADMIN DEBUG] Found " + allTickets.size() + " tickets in database");
            
            // Láº¥y táº¥t cáº£ bookings tá»« database
            List<Booking> allBookings = bookingRepository.findAll();
            System.out.println("ðŸŽ¯ [ADMIN DEBUG] Found " + allBookings.size() + " bookings in database");
            
            Map<String, Object> debugInfo = new HashMap<>();
            debugInfo.put("totalTickets", allTickets.size());
            debugInfo.put("totalBookings", allBookings.size());
            debugInfo.put("tickets", allTickets.stream().limit(5).collect(Collectors.toList()));
            debugInfo.put("bookings", allBookings.stream().limit(5).collect(Collectors.toList()));
            
            return ResponseEntity.ok(new ResponseObject("200", "Debug info retrieved successfully!", debugInfo));
        } catch (Exception e) {
            System.err.println("ðŸŽ¯ [ADMIN DEBUG] Error: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ResponseObject("500", "Debug error: " + e.getMessage(), null));
        }
    }

    // Láº¥y danh sÃ¡ch Ä‘áº·t vÃ© vá»›i chi tiáº¿t Ä‘áº§y Ä‘á»§ - Sá»­ dá»¥ng TicketService Ä‘á»ƒ láº¥y táº¥t cáº£ vÃ©
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping
    public ResponseEntity<ResponseObject> getAllBookings() {
        try {
            // Sá»­ dá»¥ng TicketService Ä‘á»ƒ láº¥y táº¥t cáº£ vÃ© cá»§a táº¥t cáº£ user
            List<BookingDetailsResponse> tickets = ticketService.getAllTicketsWithDetails();
            return ResponseEntity.ok(new ResponseObject("200", "All tickets retrieved successfully! Found " + tickets.size() + " tickets", tickets));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ResponseObject("500", "Error retrieving tickets: " + e.getMessage(), null));
        }
    }
    
    // Láº¥y danh sÃ¡ch Ä‘áº·t vÃ© vá»›i phÃ¢n trang vÃ  filter (giá»¯ láº¡i cho tÆ°Æ¡ng lai)
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/filtered")
    public ResponseEntity<ResponseObject> getAllBookingsWithFilters(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String movieTitle,
            @RequestParam(required = false) String username) {
        try {
            Page<Booking> bookings = bookingService.getAllBookingsWithFilters(page, size, status, movieTitle, username);
            return ResponseEntity.ok(new ResponseObject("200", "Bookings retrieved successfully!", bookings));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ResponseObject("500", "Error retrieving bookings: " + e.getMessage(), null));
        }
    }

    // Láº¥y chi tiáº¿t Ä‘áº·t vÃ©
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/{bookingId}")
    public ResponseEntity<ResponseObject> getBookingById(@PathVariable Long bookingId) {
        try {
            Map<String, Object> bookingDetails = bookingService.getBookingDetails(bookingId);
            return ResponseEntity.ok(new ResponseObject("200", "Booking details retrieved successfully!", bookingDetails));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body(new ResponseObject("404", "Booking not found: " + e.getMessage(), null));
        }
    }

    // Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘áº·t vÃ©
    @PreAuthorize("hasRole('ADMIN')")
    @PutMapping("/{bookingId}/status")
    public ResponseEntity<ResponseObject> updateBookingStatus(
            @PathVariable Long bookingId,
            @RequestBody Map<String, String> statusUpdate) {
        try {
            String newStatus = statusUpdate.get("status");
            Booking updatedBooking = bookingService.updateBookingStatus(bookingId, newStatus);
            return ResponseEntity.ok(new ResponseObject("200", "Booking status updated successfully!", updatedBooking));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                .body(new ResponseObject("400", "Error updating booking status: " + e.getMessage(), null));
        }
    }

    // Há»§y Ä‘áº·t vÃ©
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{bookingId}")
    public ResponseEntity<ResponseObject> cancelBooking(@PathVariable Long bookingId) {
        try {
            bookingService.cancelBooking(bookingId);
            return ResponseEntity.ok(new ResponseObject("200", "Booking cancelled successfully!", null));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST)
                .body(new ResponseObject("400", "Error cancelling booking: " + e.getMessage(), null));
        }
    }

    // Thá»‘ng kÃª Ä‘áº·t vÃ©
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/stats")
    public ResponseEntity<ResponseObject> getBookingStats(
            @RequestParam(required = false) String period) {
        try {
            Map<String, Object> stats = bookingService.getBookingStats(period);
            return ResponseEntity.ok(new ResponseObject("200", "Booking statistics retrieved successfully!", stats));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ResponseObject("500", "Error retrieving booking statistics: " + e.getMessage(), null));
        }
    }

    // Láº¥y gháº¿ cÃ³ sáºµn cho suáº¥t chiáº¿u
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/showtime/{showtimeId}/seats")
    public ResponseEntity<ResponseObject> getShowtimeSeats(@PathVariable Long showtimeId) {
        try {
            Map<String, Object> seatInfo = bookingService.getShowtimeSeatInfo(showtimeId);
            return ResponseEntity.ok(new ResponseObject("200", "Showtime seat information retrieved successfully!", seatInfo));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ResponseObject("500", "Error retrieving seat information: " + e.getMessage(), null));
        }
    }

    // TÃ¬m kiáº¿m Ä‘áº·t vÃ©
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/search")
    public ResponseEntity<ResponseObject> searchBookings(
            @RequestParam String query,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        try {
            Page<Booking> bookings = bookingService.searchBookings(query, page, size);
            return ResponseEntity.ok(new ResponseObject("200", "Bookings search completed successfully!", bookings));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ResponseObject("500", "Error searching bookings: " + e.getMessage(), null));
        }
    }

    // Xuáº¥t bÃ¡o cÃ¡o Ä‘áº·t vÃ©
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/export")
    public ResponseEntity<ResponseObject> exportBookings(
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            @RequestParam(required = false) String format) {
        try {
            Map<String, Object> exportData = bookingService.exportBookings(startDate, endDate, format);
            return ResponseEntity.ok(new ResponseObject("200", "Bookings exported successfully!", exportData));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ResponseObject("500", "Error exporting bookings: " + e.getMessage(), null));
        }
    }
} 