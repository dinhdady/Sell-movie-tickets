# Script ƒë·ªÉ test c·ª• th·ªÉ v·ªõi phim "T·ª¨ CHI·∫æN TR√äN KH√îNG"
Write-Host "üé¨ Testing showtime display for 'T·ª¨ CHI·∫æN TR√äN KH√îNG'" -ForegroundColor Yellow

# T√¨m phim "T·ª¨ CHI·∫æN TR√äN KH√îNG"
Write-Host "üîç Searching for movie 'T·ª¨ CHI·∫æN TR√äN KH√îNG'..." -ForegroundColor Blue
try {
    $response = Invoke-RestMethod -Uri "http://localhost:8080/api/movie" -Method GET
    $movies = $response.movies
    
    $targetMovie = $movies | Where-Object { $_.title -like "*T·ª¨ CHI·∫æN TR√äN KH√îNG*" -or $_.title -like "*T·ª¨ CHI·∫æN*" }
    
    if ($targetMovie) {
        Write-Host "‚úÖ Found movie: $($targetMovie.title) (ID: $($targetMovie.id))" -ForegroundColor Green
        
        # Test API showtime cho phim n√†y
        Write-Host "`nüîç Testing showtime API for movie ID $($targetMovie.id)..." -ForegroundColor Blue
        try {
            $showtimeResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/showtime/movie/$($targetMovie.id)" -Method GET
            Write-Host "‚úÖ Showtime API response received" -ForegroundColor Green
            Write-Host "Response state: $($showtimeResponse.state)" -ForegroundColor Cyan
            Write-Host "Response message: $($showtimeResponse.message)" -ForegroundColor Cyan
            
            if ($showtimeResponse.object) {
                $showtimes = $showtimeResponse.object
                Write-Host "Found $($showtimes.Count) showtimes for this movie:" -ForegroundColor Green
                foreach ($showtime in $showtimes) {
                    Write-Host "  - Showtime ID: $($showtime.id)" -ForegroundColor White
                    Write-Host "    Start: $($showtime.startTime)" -ForegroundColor White
                    Write-Host "    End: $($showtime.endTime)" -ForegroundColor White
                    Write-Host "    Room: $($showtime.roomName)" -ForegroundColor White
                    Write-Host "    Cinema: $($showtime.cinemaName)" -ForegroundColor White
                    Write-Host ""
                }
            } else {
                Write-Host "‚ö†Ô∏è No showtimes found in response object" -ForegroundColor Yellow
            }
        } catch {
            Write-Host "‚ùå Error calling showtime API: $($_.Exception.Message)" -ForegroundColor Red
        }
        
        # T·∫°o su·∫•t chi·∫øu test n·∫øu ch∆∞a c√≥
        if ($showtimes.Count -eq 0) {
            Write-Host "`nüîç Creating test showtime for this movie..." -ForegroundColor Blue
            $showtimeData = @{
                movieId = $targetMovie.id
                roomId = 1
                startTime = (Get-Date).AddDays(1).ToString("yyyy-MM-ddTHH:mm")
                endTime = (Get-Date).AddDays(1).AddHours(2).ToString("yyyy-MM-ddTHH:mm")
            }
            
            try {
                $createResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/showtime" -Method POST -Body ($showtimeData | ConvertTo-Json) -ContentType "application/json"
                Write-Host "‚úÖ Test showtime created successfully!" -ForegroundColor Green
                Write-Host "Showtime ID: $($createResponse.object.id)" -ForegroundColor Green
                
                # Test l·∫°i API sau khi t·∫°o
                Write-Host "`nüîç Testing showtime API again after creation..." -ForegroundColor Blue
                $showtimeResponse2 = Invoke-RestMethod -Uri "http://localhost:8080/api/showtime/movie/$($targetMovie.id)" -Method GET
                Write-Host "Found $($showtimeResponse2.object.Count) showtimes after creation" -ForegroundColor Green
            } catch {
                Write-Host "‚ùå Error creating showtime: $($_.Exception.Message)" -ForegroundColor Red
            }
        }
        
        Write-Host "`nüåê Test admin interface at: http://localhost:5173/admin/movies" -ForegroundColor Yellow
        Write-Host "`nüéØ Steps to test:" -ForegroundColor Blue
        Write-Host "1. Go to admin movies page" -ForegroundColor White
        Write-Host "2. Find movie: '$($targetMovie.title)'" -ForegroundColor White
        Write-Host "3. Click calendar icon (üìÖ) to view showtimes" -ForegroundColor White
        Write-Host "4. Check if showtimes are displayed correctly" -ForegroundColor White
        Write-Host "5. Click 'Th√™m su·∫•t chi·∫øu' button" -ForegroundColor White
        Write-Host "6. Check if current showtimes are listed in the modal" -ForegroundColor White
        
    } else {
        Write-Host "‚ùå Movie 'T·ª¨ CHI·∫æN TR√äN KH√îNG' not found" -ForegroundColor Red
        Write-Host "Available movies:" -ForegroundColor Yellow
        foreach ($movie in $movies) {
            Write-Host "  - $($movie.title) (ID: $($movie.id))" -ForegroundColor White
        }
        
        # T·∫°o phim test
        Write-Host "`nüîç Creating test movie 'T·ª¨ CHI·∫æN TR√äN KH√îNG'..." -ForegroundColor Blue
        $movieData = @{
            title = "T·ª¨ CHI·∫æN TR√äN KH√îNG"
            description = "M·ªôt b·ªô phim h√†nh ƒë·ªông ƒë·∫ßy k·ªãch t√≠nh"
            duration = 120
            releaseDate = "2024-12-25"
            genre = "H√†nh ƒë·ªông"
            director = "Test Director"
            trailerUrl = "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
            language = "Ti·∫øng Vi·ªát"
            cast = "Test Cast"
            rating = 8.5
            status = "NOW_SHOWING"
            price = 100000
            filmRating = "PG13"
        }
        
        try {
            $createResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/movie/add" -Method POST -Form $movieData
            Write-Host "‚úÖ Test movie created with ID: $($createResponse.data.id)" -ForegroundColor Green
            Write-Host "üåê You can now test at: http://localhost:5173/admin/movies" -ForegroundColor Yellow
        } catch {
            Write-Host "‚ùå Error creating test movie: $($_.Exception.Message)" -ForegroundColor Red
        }
    }
    
} catch {
    Write-Host "‚ùå Error getting movies: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`nüìã Debug checklist:" -ForegroundColor Blue
Write-Host "‚úÖ Check browser console for debug logs" -ForegroundColor Green
Write-Host "‚úÖ Verify API response format" -ForegroundColor Green
Write-Host "‚úÖ Check showtimes state in React component" -ForegroundColor Green
Write-Host "‚úÖ Verify modal display logic" -ForegroundColor Green

Write-Host "`nüèÅ Test completed" -ForegroundColor Blue
