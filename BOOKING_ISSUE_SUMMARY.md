# T√≥m t·∫Øt v·∫•n ƒë·ªÅ thanh to√°n v√† gi·∫£i ph√°p

## üîç V·∫•n ƒë·ªÅ ch√≠nh

**Frontend g·ª≠i showtimeId=6 nh∆∞ng database kh√¥ng c√≥ showtime ID 6**

### Nguy√™n nh√¢n:
1. **URL parameter**: Frontend nh·∫≠n `showtime=6` t·ª´ URL parameter
2. **Database kh√¥ng c√≥**: Database ch·ªâ c√≥ showtime ID 11-20, kh√¥ng c√≥ ID 6
3. **Logic sai**: Frontend v·∫´n truy·ªÅn showtime ID 6 v√†o BookingForm d√π kh√¥ng t√¨m th·∫•y trong API

### Lu·ªìng l·ªói:
```
URL: /booking/7?showtime=6
‚Üì
Frontend l·∫•y preselectedShowtimeId = "6"
‚Üì
G·ªçi API showtimeAPI.getByMovieId(7)
‚Üì
API tr·∫£ v·ªÅ showtimes v·ªõi ID 11-20
‚Üì
Frontend t√¨m showtime.id === 6 ‚Üí Kh√¥ng t√¨m th·∫•y
‚Üì
selectedShowtime = undefined
‚Üì
Nh∆∞ng v·∫´n truy·ªÅn showtime.id = 6 v√†o BookingForm
‚Üì
Backend nh·∫≠n showtimeId=6 ‚Üí L·ªói "Showtime kh√¥ng h·ª£p l·ªá"
```

## ‚úÖ Gi·∫£i ph√°p ƒë√£ th·ª±c hi·ªán

### 1. S·ª≠a Frontend Logic
- **File**: `frontend/src/pages/Booking.tsx`
- **Thay ƒë·ªïi**: Th√™m validation ƒë·ªÉ ch·ªâ auto-select showtime n·∫øu t√¨m th·∫•y trong API response
- **Code**:
```typescript
const selectedShowtime = showtimesResponse.object.find(st => st.id === parseInt(preselectedShowtimeId));
if (selectedShowtime) {
  console.log('‚úÖ Found preselected showtime from API:', selectedShowtime);
  setSelectedShowtime(selectedShowtime);
  // ...
} else {
  console.log('‚ùå Preselected showtime ID', preselectedShowtimeId, 'not found in API response');
  console.log('Available showtime IDs:', showtimesResponse.object.map(st => st.id));
  setError('Su·∫•t chi·∫øu ƒë√£ ch·ªçn kh√¥ng c√≤n t·ªìn t·∫°i. Vui l√≤ng ch·ªçn su·∫•t chi·∫øu kh√°c.');
}
```

### 2. T·∫°o Script Database
- **File**: `fix_showtime_6.sql`
- **M·ª•c ƒë√≠ch**: T·∫°o showtime ID 6 trong database n·∫øu c·∫ßn
- **SQL**:
```sql
INSERT INTO showtimes (id, movie_id, room_id, start_time, end_time, price, status, created_at, updated_at) 
VALUES (6, 7, 1, '2025-09-22 14:00:00', '2025-09-22 16:00:00', 120000, 'ACTIVE', NOW(), NOW())
ON DUPLICATE KEY UPDATE ...;
```

## üß™ C√°ch test

### 1. Ch·∫°y SQL script
```bash
mysql -u root -p < fix_showtime_6.sql
```

### 2. Test API
```bash
# Test showtime API
curl -X GET "http://localhost:8080/api/showtime" -H "Authorization: Bearer YOUR_TOKEN"

# Test order creation
curl -X POST "http://localhost:8080/api/order" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"userId":"USER_ID","showtimeId":6,"totalPrice":120000,"customerEmail":"test@example.com"}'
```

### 3. Test Frontend
1. Truy c·∫≠p: `http://localhost:5173/booking/7?showtime=6`
2. Ki·ªÉm tra console log:
   - N·∫øu c√≥ showtime ID 6: "‚úÖ Found preselected showtime from API"
   - N·∫øu kh√¥ng c√≥: "‚ùå Preselected showtime ID 6 not found in API response"

## üéØ K·∫øt qu·∫£ mong ƒë·ª£i

### Tr∆∞·ªõc khi s·ª≠a:
- Frontend g·ª≠i showtimeId=6
- Backend tr·∫£ v·ªÅ l·ªói "Showtime kh√¥ng h·ª£p l·ªá"
- Thanh to√°n th·∫•t b·∫°i

### Sau khi s·ª≠a:
- Frontend ki·ªÉm tra showtime ID c√≥ t·ªìn t·∫°i trong API response
- N·∫øu c√≥: Auto-select showtime ƒë√≥
- N·∫øu kh√¥ng: Hi·ªÉn th·ªã l·ªói v√† y√™u c·∫ßu ch·ªçn showtime kh√°c
- Thanh to√°n th√†nh c√¥ng v·ªõi showtime ID h·ª£p l·ªá

## üìù Files ƒë√£ thay ƒë·ªïi

1. `frontend/src/pages/Booking.tsx` - S·ª≠a logic auto-select showtime
2. `fix_showtime_6.sql` - Script t·∫°o showtime ID 6
3. `test-complete-booking-flow.ps1` - Script test to√†n b·ªô lu·ªìng

## üöÄ B∆∞·ªõc ti·∫øp theo

1. **Ch·∫°y SQL script** ƒë·ªÉ t·∫°o showtime ID 6
2. **Restart backend** n·∫øu c·∫ßn
3. **Test frontend** v·ªõi URL c√≥ showtime parameter
4. **Ki·ªÉm tra console log** ƒë·ªÉ x√°c nh·∫≠n logic ho·∫°t ƒë·ªông ƒë√∫ng
5. **Test thanh to√°n** ƒë·ªÉ ƒë·∫£m b·∫£o flow ho√†n ch·ªânh
