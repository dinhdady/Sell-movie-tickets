# Script ƒë·ªÉ test ch·ª©c nƒÉng ƒëƒÉng k√Ω sau khi s·ª≠a l·ªói
Write-Host "üîß Testing register functionality after fix..." -ForegroundColor Yellow

# Test 1: ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi
Write-Host "`nüîç Test 1: Registering new user..." -ForegroundColor Blue
$registerData = @{
    username = "testuser$(Get-Random -Maximum 1000)"
    email = "test$(Get-Random -Maximum 1000)@example.com"
    password = "password123"
    fullName = "Test User"
    phone = "0123456789"
} | ConvertTo-Json

Write-Host "Register data: $registerData" -ForegroundColor Cyan

try {
    $registerResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/register" -Method POST -Body $registerData -ContentType "application/json"
    Write-Host "‚úÖ Registration successful!" -ForegroundColor Green
    Write-Host "Response: $($registerResponse | ConvertTo-Json -Depth 3)" -ForegroundColor Cyan
    
    if ($registerResponse.object.verificationRequired) {
        Write-Host "‚úÖ Email verification required - working correctly!" -ForegroundColor Green
        Write-Host "Email: $($registerResponse.object.email)" -ForegroundColor Cyan
    } else {
        Write-Host "‚ö†Ô∏è Email verification not required - check configuration" -ForegroundColor Yellow
    }
} catch {
    Write-Host "‚ùå Registration failed: $($_.Exception.Message)" -ForegroundColor Red
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error details: $errorBody" -ForegroundColor Red
    }
}

# Test 2: ƒêƒÉng k√Ω v·ªõi email ƒë√£ t·ªìn t·∫°i
Write-Host "`nüîç Test 2: Registering with existing email..." -ForegroundColor Blue
$existingEmailData = @{
    username = "testuser$(Get-Random -Maximum 1000)"
    email = "admin@example.com"  # Email ƒë√£ t·ªìn t·∫°i
    password = "password123"
    fullName = "Test User"
    phone = "0123456789"
} | ConvertTo-Json

try {
    $existingEmailResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/register" -Method POST -Body $existingEmailData -ContentType "application/json"
    Write-Host "‚ö†Ô∏è Existing email was accepted (unexpected)" -ForegroundColor Yellow
} catch {
    Write-Host "‚úÖ Existing email properly rejected" -ForegroundColor Green
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error message: $errorBody" -ForegroundColor Cyan
    }
}

# Test 3: ƒêƒÉng k√Ω v·ªõi username ƒë√£ t·ªìn t·∫°i
Write-Host "`nüîç Test 3: Registering with existing username..." -ForegroundColor Blue
$existingUsernameData = @{
    username = "admin"  # Username ƒë√£ t·ªìn t·∫°i
    email = "test$(Get-Random -Maximum 1000)@example.com"
    password = "password123"
    fullName = "Test User"
    phone = "0123456789"
} | ConvertTo-Json

try {
    $existingUsernameResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/register" -Method POST -Body $existingUsernameData -ContentType "application/json"
    Write-Host "‚ö†Ô∏è Existing username was accepted (unexpected)" -ForegroundColor Yellow
} catch {
    Write-Host "‚úÖ Existing username properly rejected" -ForegroundColor Green
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error message: $errorBody" -ForegroundColor Cyan
    }
}

# Test 4: ƒêƒÉng k√Ω v·ªõi d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
Write-Host "`nüîç Test 4: Registering with invalid data..." -ForegroundColor Blue
$invalidData = @{
    username = ""
    email = "invalid-email"
    password = "123"  # Qu√° ng·∫Øn
    fullName = ""
    phone = ""
} | ConvertTo-Json

try {
    $invalidResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/register" -Method POST -Body $invalidData -ContentType "application/json"
    Write-Host "‚ö†Ô∏è Invalid data was accepted (unexpected)" -ForegroundColor Yellow
} catch {
    Write-Host "‚úÖ Invalid data properly rejected" -ForegroundColor Green
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error message: $errorBody" -ForegroundColor Cyan
    }
}

Write-Host "`nüåê Test frontend at:" -ForegroundColor Blue
Write-Host "Register: http://localhost:5173/register" -ForegroundColor Cyan
Write-Host "Email Verification: http://localhost:5173/verify-email" -ForegroundColor Cyan

Write-Host "`nüìã Expected behavior:" -ForegroundColor Blue
Write-Host "1. Registration should succeed with verification required" -ForegroundColor White
Write-Host "2. Existing email/username should be rejected" -ForegroundColor White
Write-Host "3. Invalid data should be rejected" -ForegroundColor White
Write-Host "4. Email verification should be sent" -ForegroundColor White

Write-Host "`nüèÅ Register fix test completed" -ForegroundColor Green
