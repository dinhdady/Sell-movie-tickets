# Script ƒë·ªÉ test ch·ª©c nƒÉng c·∫≠p nh·∫≠t profile
Write-Host "üë§ Testing profile update functionality" -ForegroundColor Yellow

# Test 1: L·∫•y th√¥ng tin user hi·ªán t·∫°i
Write-Host "`nüîç Test 1: Getting current user profile..." -ForegroundColor Blue
try {
    $profileResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/user/profile" -Method GET
    Write-Host "‚úÖ Profile retrieved successfully!" -ForegroundColor Green
    Write-Host "User ID: $($profileResponse.object.id)" -ForegroundColor Cyan
    Write-Host "Username: $($profileResponse.object.username)" -ForegroundColor Cyan
    Write-Host "Email: $($profileResponse.object.email)" -ForegroundColor Cyan
    Write-Host "Full Name: $($profileResponse.object.fullName)" -ForegroundColor Cyan
    Write-Host "Phone: $($profileResponse.object.phoneNumber)" -ForegroundColor Cyan
    
    $userId = $profileResponse.object.id
} catch {
    Write-Host "‚ùå Error getting profile: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# Test 2: C·∫≠p nh·∫≠t th√¥ng tin profile
Write-Host "`nüîç Test 2: Updating user profile..." -ForegroundColor Blue
$updateData = @{
    fullName = "Test User Updated"
    phoneNumber = "0123456789"
}

try {
    $updateResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/user/$userId/profile" -Method PUT -Body ($updateData | ConvertTo-Json) -ContentType "application/json"
    Write-Host "‚úÖ Profile updated successfully!" -ForegroundColor Green
    Write-Host "Updated Full Name: $($updateResponse.object.fullName)" -ForegroundColor Cyan
    Write-Host "Updated Phone: $($updateResponse.object.phoneNumber)" -ForegroundColor Cyan
} catch {
    Write-Host "‚ùå Error updating profile: $($_.Exception.Message)" -ForegroundColor Red
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error details: $errorBody" -ForegroundColor Red
    }
}

# Test 3: Ki·ªÉm tra th√¥ng tin sau khi c·∫≠p nh·∫≠t
Write-Host "`nüîç Test 3: Verifying updated profile..." -ForegroundColor Blue
try {
    $verifyResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/user/profile" -Method GET
    Write-Host "‚úÖ Profile verification successful!" -ForegroundColor Green
    Write-Host "Current Full Name: $($verifyResponse.object.fullName)" -ForegroundColor Cyan
    Write-Host "Current Phone: $($verifyResponse.object.phoneNumber)" -ForegroundColor Cyan
    
    if ($verifyResponse.object.fullName -eq "Test User Updated") {
        Write-Host "‚úÖ Full name update confirmed!" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è Full name update not reflected" -ForegroundColor Yellow
    }
    
    if ($verifyResponse.object.phoneNumber -eq "0123456789") {
        Write-Host "‚úÖ Phone number update confirmed!" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è Phone number update not reflected" -ForegroundColor Yellow
    }
} catch {
    Write-Host "‚ùå Error verifying profile: $($_.Exception.Message)" -ForegroundColor Red
}

# Test 4: Test v·ªõi d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
Write-Host "`nüîç Test 4: Testing with invalid data..." -ForegroundColor Blue
$invalidData = @{
    fullName = ""
    phoneNumber = "invalid-phone"
}

try {
    $invalidResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/user/$userId/profile" -Method PUT -Body ($invalidData | ConvertTo-Json) -ContentType "application/json"
    Write-Host "‚ö†Ô∏è Invalid data was accepted (unexpected)" -ForegroundColor Yellow
} catch {
    Write-Host "‚úÖ Invalid data properly rejected" -ForegroundColor Green
    Write-Host "Error message: $($_.Exception.Message)" -ForegroundColor Cyan
}

Write-Host "`nüåê Test frontend at: http://localhost:5173/profile" -ForegroundColor Yellow
Write-Host "`nüéØ Steps to test in frontend:" -ForegroundColor Blue
Write-Host "1. Go to profile page" -ForegroundColor White
Write-Host "2. Click 'Ch·ªânh s·ª≠a' button" -ForegroundColor White
Write-Host "3. Update full name and phone number" -ForegroundColor White
Write-Host "4. Click 'L∆∞u' button" -ForegroundColor White
Write-Host "5. Verify changes are saved" -ForegroundColor White

Write-Host "`nüìã API Endpoints tested:" -ForegroundColor Blue
Write-Host "‚úÖ GET /api/user/profile - Get current user profile" -ForegroundColor Green
Write-Host "‚úÖ PUT /api/user/{userId}/profile - Update user profile" -ForegroundColor Green
Write-Host "‚úÖ Error handling for invalid data" -ForegroundColor Green

Write-Host "`nüèÅ Test completed" -ForegroundColor Blue
