# Script ƒë·ªÉ c·∫≠p nh·∫≠t database schema cho email verification
Write-Host "üóÑÔ∏è Updating database schema for email verification..." -ForegroundColor Yellow

# T·∫°o script SQL ƒë·ªÉ th√™m b·∫£ng email_verification_tokens
$sqlScript = @"
-- T·∫°o b·∫£ng email_verification_tokens
CREATE TABLE IF NOT EXISTS email_verification_tokens (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    token VARCHAR(255) NOT NULL UNIQUE,
    user_id VARCHAR(8) NOT NULL,
    expiry_date DATETIME NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    verified_at DATETIME NULL,
    is_used BOOLEAN NOT NULL DEFAULT FALSE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_token (token),
    INDEX idx_user_id (user_id),
    INDEX idx_expiry_date (expiry_date)
);

-- Th√™m c·ªôt is_email_verified v√†o b·∫£ng users n·∫øu ch∆∞a c√≥
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS is_email_verified BOOLEAN NOT NULL DEFAULT FALSE;

-- C·∫≠p nh·∫≠t t·∫•t c·∫£ user hi·ªán t·∫°i th√†nh ƒë√£ verify (ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn user c≈©)
UPDATE users 
SET is_email_verified = TRUE 
WHERE is_email_verified IS NULL OR is_email_verified = FALSE;

-- Hi·ªÉn th·ªã k·∫øt qu·∫£
SELECT 'Database schema updated successfully' as status;
SELECT COUNT(*) as total_users FROM users;
SELECT COUNT(*) as verified_users FROM users WHERE is_email_verified = TRUE;
SELECT COUNT(*) as unverified_users FROM users WHERE is_email_verified = FALSE;
"@

# L∆∞u script SQL
$sqlScript | Out-File -FilePath "update_email_verification_schema.sql" -Encoding UTF8

Write-Host "üìù Created SQL script: update_email_verification_schema.sql" -ForegroundColor Green

# T·∫°o script ƒë·ªÉ ki·ªÉm tra database
$checkScript = @"
-- Ki·ªÉm tra c·∫•u tr√∫c b·∫£ng email_verification_tokens
DESCRIBE email_verification_tokens;

-- Ki·ªÉm tra c·∫•u tr√∫c b·∫£ng users
DESCRIBE users;

-- Ki·ªÉm tra d·ªØ li·ªáu m·∫´u
SELECT id, username, email, is_email_verified, created_at 
FROM users 
ORDER BY created_at DESC 
LIMIT 5;
"@

$checkScript | Out-File -FilePath "check_email_verification_schema.sql" -Encoding UTF8

Write-Host "üìù Created check script: check_email_verification_schema.sql" -ForegroundColor Green

Write-Host "`nüîß Manual database update instructions:" -ForegroundColor Blue
Write-Host "1. Open MySQL command line or MySQL Workbench" -ForegroundColor White
Write-Host "2. Run: source update_email_verification_schema.sql" -ForegroundColor Cyan
Write-Host "3. Verify: source check_email_verification_schema.sql" -ForegroundColor Cyan

Write-Host "`nüìã Quick commands:" -ForegroundColor Yellow
Write-Host "mysql -u root -p" -ForegroundColor White
Write-Host "USE movietickets;" -ForegroundColor White
Write-Host "source update_email_verification_schema.sql;" -ForegroundColor White

Write-Host "`nüåê After updating database:" -ForegroundColor Blue
Write-Host "1. Restart Spring Boot application" -ForegroundColor White
Write-Host "2. Test email verification functionality" -ForegroundColor White
Write-Host "3. Run: .\test-email-verification.ps1" -ForegroundColor White

Write-Host "`n‚ö†Ô∏è  Important notes:" -ForegroundColor Yellow
Write-Host "- All existing users will be marked as verified" -ForegroundColor White
Write-Host "- New users will need email verification" -ForegroundColor White
Write-Host "- Email verification tokens expire after 24 hours" -ForegroundColor White

Write-Host "`nüèÅ Database schema update scripts ready" -ForegroundColor Green
