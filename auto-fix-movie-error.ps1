# Script t·ª± ƒë·ªông s·ª≠a l·ªói Movie reference
Write-Host "ü§ñ Auto-fixing Movie reference error..." -ForegroundColor Yellow

# T√¨m MySQL executable
$mysqlPaths = @(
    "C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe",
    "C:\Program Files (x86)\MySQL\MySQL Server 8.0\bin\mysql.exe",
    "C:\xampp\mysql\bin\mysql.exe",
    "C:\wamp64\bin\mysql\mysql8.0.21\bin\mysql.exe"
)

$mysqlExe = $null
foreach ($path in $mysqlPaths) {
    if (Test-Path $path) {
        $mysqlExe = $path
        break
    }
}

if (-not $mysqlExe) {
    Write-Host "‚ùå MySQL executable not found. Please install MySQL or update the paths." -ForegroundColor Red
    Write-Host "Trying to use mysql command directly..." -ForegroundColor Yellow
    $mysqlExe = "mysql"
}

Write-Host "Using MySQL: $mysqlExe" -ForegroundColor Cyan

# T·∫°o script SQL ƒë·ªÉ s·ª≠a l·ªói
$fixSQL = @"
USE movietickets;

-- T·∫°o movie ID 1 n·∫øu kh√¥ng t·ªìn t·∫°i
INSERT IGNORE INTO movies (id, title, description, director, duration, genre, language, film_rating, price, rating, release_date, status, created_at, updated_at)
VALUES (1, 'Movie Placeholder', 'This is a placeholder movie for fixing reference errors', 'Unknown Director', 120, 'Action', 'Vietnamese', 'PG13', 50000, 7.0, '2024-01-01', 'NOW_SHOWING', NOW(), NOW());

-- Ki·ªÉm tra k·∫øt qu·∫£
SELECT 'Fix completed - Movie ID 1:' as info, id, title, status FROM movies WHERE id = 1;

-- Ki·ªÉm tra showtimes tham chi·∫øu movie ID 1
SELECT 'Showtimes referencing movie ID 1:' as info, COUNT(*) as count FROM showtimes WHERE movie_id = 1;

-- Ki·ªÉm tra bookings tham chi·∫øu movie ID 1
SELECT 'Bookings referencing movie ID 1:' as info, COUNT(*) as count 
FROM bookings b 
JOIN showtimes s ON b.showtime_id = s.id 
WHERE s.movie_id = 1;
"@

# L∆∞u script SQL
$fixSQL | Out-File -FilePath "auto_fix_movie.sql" -Encoding UTF8

Write-Host "üìù Created auto fix script: auto_fix_movie.sql" -ForegroundColor Green

# Th·ª≠ ch·∫°y script
Write-Host "`nüîß Executing fix script..." -ForegroundColor Blue
try {
    $sqlContent = Get-Content "auto_fix_movie.sql" -Raw
    $result = & $mysqlExe -u root -p123456 -e $sqlContent 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Fix script executed successfully!" -ForegroundColor Green
        Write-Host "Result:" -ForegroundColor Cyan
        Write-Host $result -ForegroundColor White
    } else {
        Write-Host "‚ö†Ô∏è Script execution had issues, but may have worked" -ForegroundColor Yellow
        Write-Host "Output:" -ForegroundColor Cyan
        Write-Host $result -ForegroundColor White
    }
} catch {
    Write-Host "‚ùå Error executing script: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "Please run manually: mysql -u root -p < auto_fix_movie.sql" -ForegroundColor Yellow
}

# Ki·ªÉm tra xem l·ªói ƒë√£ ƒë∆∞·ª£c s·ª≠a ch∆∞a
Write-Host "`nüîç Testing if error is fixed..." -ForegroundColor Blue
try {
    $testResult = & $mysqlExe -u root -p123456 -e "USE movietickets; SELECT COUNT(*) as movie_count FROM movies WHERE id = 1;" 2>&1
    if ($testResult -match "movie_count.*1") {
        Write-Host "‚úÖ Movie ID 1 now exists!" -ForegroundColor Green
    } else {
        Write-Host "‚ö†Ô∏è Movie ID 1 may still not exist" -ForegroundColor Yellow
    }
} catch {
    Write-Host "‚ùå Could not verify fix" -ForegroundColor Red
}

Write-Host "`nüåê Next steps:" -ForegroundColor Blue
Write-Host "1. Restart your Spring Boot application" -ForegroundColor White
Write-Host "2. Test at: http://localhost:5173" -ForegroundColor White
Write-Host "3. Check application logs for any remaining errors" -ForegroundColor White

Write-Host "`nüìã If the error persists:" -ForegroundColor Yellow
Write-Host "1. Check if there are other missing movie references" -ForegroundColor White
Write-Host "2. Consider using the complete reset script" -ForegroundColor White
Write-Host "3. Check foreign key constraints" -ForegroundColor White

Write-Host "`nüèÅ Auto-fix completed" -ForegroundColor Green
