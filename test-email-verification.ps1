# Script ƒë·ªÉ test ch·ª©c nƒÉng email verification
Write-Host "üìß Testing email verification functionality" -ForegroundColor Yellow

# Test 1: ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi
Write-Host "`nüîç Test 1: Registering new user..." -ForegroundColor Blue
$registerData = @{
    username = "testuser$(Get-Random -Maximum 1000)"
    email = "test$(Get-Random -Maximum 1000)@example.com"
    password = "password123"
    fullName = "Test User"
    phone = "0123456789"
} | ConvertTo-Json

try {
    $registerResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/register" -Method POST -Body $registerData -ContentType "application/json"
    Write-Host "‚úÖ Registration successful!" -ForegroundColor Green
    Write-Host "Response: $($registerResponse | ConvertTo-Json -Depth 3)" -ForegroundColor Cyan
    
    $email = $registerResponse.object.email
    Write-Host "Email: $email" -ForegroundColor Cyan
    Write-Host "Verification required: $($registerResponse.object.verificationRequired)" -ForegroundColor Cyan
} catch {
    Write-Host "‚ùå Registration failed: $($_.Exception.Message)" -ForegroundColor Red
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error details: $errorBody" -ForegroundColor Red
    }
    exit 1
}

# Test 2: Ki·ªÉm tra tr·∫°ng th√°i email verification
Write-Host "`nüîç Test 2: Checking email verification status..." -ForegroundColor Blue
try {
    $statusResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/check-email-verification?email=$email" -Method GET
    Write-Host "‚úÖ Email verification status retrieved!" -ForegroundColor Green
    Write-Host "Email: $($statusResponse.object.email)" -ForegroundColor Cyan
    Write-Host "Is verified: $($statusResponse.object.isVerified)" -ForegroundColor Cyan
} catch {
    Write-Host "‚ùå Error checking verification status: $($_.Exception.Message)" -ForegroundColor Red
}

# Test 3: Test v·ªõi token kh√¥ng h·ª£p l·ªá
Write-Host "`nüîç Test 3: Testing with invalid token..." -ForegroundColor Blue
$invalidTokenData = @{
    token = "invalid-token-123"
} | ConvertTo-Json

try {
    $verifyResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/verify-email" -Method POST -Body $invalidTokenData -ContentType "application/json"
    Write-Host "‚ö†Ô∏è Invalid token was accepted (unexpected)" -ForegroundColor Yellow
} catch {
    Write-Host "‚úÖ Invalid token properly rejected" -ForegroundColor Green
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error message: $errorBody" -ForegroundColor Cyan
    }
}

# Test 4: G·ª≠i l·∫°i email verification
Write-Host "`nüîç Test 4: Resending verification email..." -ForegroundColor Blue
$resendData = @{
    email = $email
} | ConvertTo-Json

try {
    $resendResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/resend-verification" -Method POST -Body $resendData -ContentType "application/json"
    Write-Host "‚úÖ Verification email resent successfully!" -ForegroundColor Green
    Write-Host "Response: $($resendResponse.message)" -ForegroundColor Cyan
} catch {
    Write-Host "‚ùå Error resending verification email: $($_.Exception.Message)" -ForegroundColor Red
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error details: $errorBody" -ForegroundColor Red
    }
}

# Test 5: Test v·ªõi email kh√¥ng t·ªìn t·∫°i
Write-Host "`nüîç Test 5: Testing with non-existent email..." -ForegroundColor Blue
$nonExistentEmailData = @{
    email = "nonexistent@example.com"
} | ConvertTo-Json

try {
    $resendResponse = Invoke-RestMethod -Uri "http://localhost:8080/api/auth/resend-verification" -Method POST -Body $nonExistentEmailData -ContentType "application/json"
    Write-Host "‚ö†Ô∏è Non-existent email was accepted (unexpected)" -ForegroundColor Yellow
} catch {
    Write-Host "‚úÖ Non-existent email properly rejected" -ForegroundColor Green
    if ($_.Exception.Response) {
        $errorStream = $_.Exception.Response.GetResponseStream()
        $reader = New-Object System.IO.StreamReader($errorStream)
        $errorBody = $reader.ReadToEnd()
        Write-Host "Error message: $errorBody" -ForegroundColor Cyan
    }
}

Write-Host "`nüåê Test frontend at:" -ForegroundColor Blue
Write-Host "Register: http://localhost:5173/register" -ForegroundColor Cyan
Write-Host "Email Verification: http://localhost:5173/verify-email" -ForegroundColor Cyan
Write-Host "Login: http://localhost:5173/login" -ForegroundColor Cyan

Write-Host "`nüìã Test steps for frontend:" -ForegroundColor Blue
Write-Host "1. Go to register page" -ForegroundColor White
Write-Host "2. Fill in registration form" -ForegroundColor White
Write-Host "3. Submit form - should show verification message" -ForegroundColor White
Write-Host "4. Check email for verification token" -ForegroundColor White
Write-Host "5. Go to verify-email page" -ForegroundColor White
Write-Host "6. Enter token and verify" -ForegroundColor White
Write-Host "7. Try to login with verified account" -ForegroundColor White

Write-Host "`nüìã API Endpoints tested:" -ForegroundColor Blue
Write-Host "‚úÖ POST /api/auth/register - Register with email verification" -ForegroundColor Green
Write-Host "‚úÖ GET /api/auth/check-email-verification - Check verification status" -ForegroundColor Green
Write-Host "‚úÖ POST /api/auth/verify-email - Verify email with token" -ForegroundColor Green
Write-Host "‚úÖ POST /api/auth/resend-verification - Resend verification email" -ForegroundColor Green
Write-Host "‚úÖ Error handling for invalid data" -ForegroundColor Green

Write-Host "`nüèÅ Email verification test completed" -ForegroundColor Blue
